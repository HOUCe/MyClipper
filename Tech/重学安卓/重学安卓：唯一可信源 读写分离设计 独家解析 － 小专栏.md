---
created: 2021-10-13
source: https://xiaozhuanlan.com/topic/2049857631
author: 
---

# [重学安卓：唯一可信源 读写分离设计 独家解析 － 小专栏](https://xiaozhuanlan.com/topic/2049857631)


> [往期回顾](https://kunminx.gitbook.io/relearn-android/new_moments/zhong-xue-an-zhuo-liang-zhou-nian-hui-gu-yu-zhan-wang)，**[专栏目录](https://kunminx.gitbook.io/relearn-android/category)**，**[更新动态](https://kunminx.gitbook.io/relearn-android/new_moments)**，[优惠政策](https://kunminx.gitbook.io/relearn-android/ban-quan-sheng-ming#you-hui-zheng-ce)，[版权须知](https://kunminx.gitbook.io/relearn-android/ban-quan-sheng-ming#ban-quan-xu-zhi)
> 
> 温馨提示：如果这是第一次接触《重学安卓》，可通过上述链接来访问和快速了解《重学安卓》专栏、获取它的目录、试读内容，以及了解它的最新动态 和 发展状况。
> 
> 截至目前，专栏已对 **体系化文章** 做了 1970 余次修订，数十位群友告诉我 受专栏的启发 他们也开启了写作之路。群里不定期会有小伙伴讨论适配问题、分享原创的开源库 和 提供内推机会，订阅后可随时进群交流。

·

> 注：本文以[《Jetpack MVVM 精讲》](https://xiaozhuanlan.com/topic/0129483567)、[《脚手架 - 架构模式解析》](https://xiaozhuanlan.com/topic/8204519736) 以及
> 
> [《GitHub：Jetpack MVVM Best Practice》](https://github.com/KunMinX/Jetpack-MVVM-Best-Practice) 作为前置知识，
> 
> 假设小伙伴已完整查阅并吸收了上述内容。

## 前言

你是否还在用 Bus 发消息？

最近网传 “比特币” 之类的数字加密货币暴跌，虽然我从不涉足 “炒币” 等领域，但我十分清楚，此类 “虚拟货币” 从交易安全的角度来说是 “极不可靠” 的，因为本质上它们属于 “去中心化” 的设计，

“去中心化” 意味着权限的分散，出了问题你很难追溯事情的源头，因而坏人们很容易利用这一点去操控市场行情，普通人入局就只有被割的份。

> 那么这件事和 EventBus 还有 LiveData 又有什么关系呢？如何才能确保交易 … 啊呸 … 消息分发的 “安全” 呢？

如果你也曾 **加班加点地为 “不可预期的事件源” 的排查疲于奔命**，相信存在某种设计能彻底规避这类事情的话，那么我们随时可以继续，今天我们就是专门通过 “通俗易懂” 的方式来解答这类问题 ~

## 文章目录一览

-   前言
-   绝对自由和自由的代价
-   边界意识和监管下的真自由
-   LiveData 的本质和精髓
-   所以 LiveDataBus 的问题在于
-   用工程化的语言再捋一捋
-   关于 “唯一可信源” 的定义
-   综上

## 绝对自由和自由的代价

EventBus 是 “消息收发自由” 框架的代表，通过它，使用者可以从任意角落发送消息，并让消息在任意目标角落接收到，只要 “发送者” 和 “观察者” 此刻都处于 “在线”（registed）的状态，

这是一种 “绝对的自由”，然而 **“绝对的自由” 往往伴随着对潜在风险的全面忽视**，例如

> 1.“观察者” 的代码块中包含 “可能已变为 null” 的成员变量，极容易引发 null 安全问题，
> 
> 2.消息的可靠性没有保证，发送者发送的也许是过时的消息。

null 安全问题通常是以 App 崩溃来呈现，只需一次，就会给用户带来负面印象，而 Java 的 null 安全问题通常又难以在上线前发现，

所以有的团队改用 kotlin，在语法糖和 IDE 智能提示的协助下，主动发现潜在风险，和在编码过程中就将 null 安全问题规避，

那么关于 “不可预期事件推送” 的加班加点排查，主要就是上述提到的第二点，也即因为 “过时的”、“不一致” 的消息，而使 “单个页面内或多个页面之间，控件呈现的数据与预期不符”

—— 往往这时候你面临的是多个 “可能的发送源”，但你很难判断 “到底是哪个发送源分发的消息”，以及 “哪个发送源发送的消息才是可靠的”。

![](https://images.xiaozhuanlan.com/photo/2021/ef29c997a058aeb524c4f6227a63ab82.png)

## 边界意识和监管下的真自由

通过长期的反思和践行，我们发现，这类问题的本质是 “**公私不分**” 和 “**缺乏监管**” —— 放任发送者误将私事当做公事 **越界强加给边界外的他人**，并在公事上缺乏统一的、具备公信力的机构来收紧决策权、在其内部统一决策、和统一对外公布。

首先我们先来明确一下，什么是 “私事”，什么是 “公事”，

> 私事就是个人边界内的东西，例如 私欲。
> 
> 人际交往的层面 我们都知道要分清楚边界，不可随意越界将私欲丢给他人承担，页面交互的层面 其实同理：

把 App 看做一个部门，把 Fragments 看做是部门内的员工，那么 Fragment A 的成员变量，是它自己私域内的数据，它自己用无妨，但如果要去改变别的 Fragment（例如 Fragment B）的数据，它不能私自给 Fragment B 口头通知，不然就是犯规（因为不明就里的职场新人 Fragment B 收到了就会直接 “被迫营业”，万一结果出问题了，没有存证，找谁认责呢？），

> 那么怎么做才好呢？—— **明确边界，把握分寸** —— 作为员工，在部门内部的事情上，可以提议，但没有决策权，应把价值判断和做决定的权力还给领导，由领导来统一决策和通知，就算对领导的决策不满意，可以忍、可以离开，但无权越界干涉，

这样从大的格局来看，事情的运转就清晰了，因为**私事只在私域内运转，私事要跨域，就得先上升为公事**，而公事的决策结果究竟如何，由统一的监管小组来决策和通知，

因此，无论谁想 “发通知”，都不可随意发，而是改为 “向领导提议（request）”，由领导小组自行决策和统一通知，而这样也就最终确保了 “消息总是可靠的、一致的”，**就算出问题，我不用找别人，我就找领导** —— 只需在 “领导” 这一处看看逻辑出了什么问题就行，

也即，要想彻底解决这类问题，就得明令禁止 EventBus 这类 “绝对自由” 框架的使用，转而**寻求一种 “支持读写权限分离” 的消息通知框架，来支持 “唯一可信源消息分发” 的结构设计**，

LiveData 应运而生。

![](https://images.xiaozhuanlan.com/photo/2021/9b8bdc1f7d0732b40220caded5b725ba.png)

## LiveData 的本质和精髓

上述我们提到了 “发消息” 面临的两大潜在风险，基于这个背景，我们轻易得以推知 LiveData 的本质 ——

1.不是每个团队、每个项目都用 kotlin，所以 LiveData 有必要承担一部分 null 安全问题的规避，所以 LiveData 借助 Lifecycle 框架来在 “绝对安全” 的几个生命周期节点对 消息通知保持开放，以确保 View 实例调用 **不因生命周期而发生 null 安全问题**

> 注意它只是防生命周期的情况，其他因素导致的 视图实例为 null 的情况，它防不住，所以它的防护效果其实有限，要彻底防住还是需要 [《DataBinding 严格模式》](https://xiaozhuanlan.com/topic/9816742350) 或改用 kotlin。

2.提供 “读写分离” 的设计。注意 LiveData 被设计为父类，setValue 和 postValue 都是 protected 权限，而 public 权限只存在于 MutableLiveData 中，

> 由于英文不是中国人的母语，因而多数开发者没有去理解，甚至都没有去查一查 Mutable 的意思，很简单，其实就是 “可变” 的意思，

那么按照上文的解析，

在私域中（例如 Fragment 私有的 ViewModel 中），我们可以直接使用 MutableLiveData，每当需要通知 DataBinding 绑定的控件刷新数据时，我们在 Fragment 中直接 setValue，

而对于跨域的通信，我们则不能拿到公域的 MutableLiveData 和 setValue，而是通过 SharedViewModel 的各种 request 方法去向这位领导请示，由他自己在内部决策并最终通过 LiveData（父类）来通知到所有观察者页面。

LiveData 框架的存在就是为了支持这类事，也即 LiveData 的本质就是提供 “生命周期安全的、可靠一致的” 消息分发体验。

![](https://images.xiaozhuanlan.com/photo/2021/b5999775a5486b8a11eb1327dfb92156.png)

## 所以 LiveDataBus 的问题在于

经过上述的分析，我们轻易得知，LiveData 能规避的 null 安全问题极为有限，因而主要是侧重于通过 “权限收紧” 来确保 “消息通知可靠一致”，

LiveDataBus 的设计，注定了其无法实现 “授权收紧”（因为务必使用 MutableLiveData 以确保随处可 setValue），而仅仅是利用了 Lifecycle 带来的一些便利（无需手动注册解绑，且规避一部分 null 安全问题），

因而可谓是 **舍本逐末** —— “买前生产力、买后 \_\_ \_\_ \_\_”。

![](https://images.xiaozhuanlan.com/photo/2021/4d610fe30947520a437d3ffce567c402.png)

## 用工程化的语言再捋一捋

上文我们是基于生活常识来解析 “公私分明 + 统一监管” 的设计，

当然我们也可以用工程化的语言来重新捋一捋，

> 其实 Fragment 私域的成员变量，我们可以称之为 **“状态”、“State”，它得是可变的、粘性的**（在旋屏重建时可以自动倒灌最后一次信息），
> 
> 而那些公域的消息，我们可以称之为 **“事件”、“Event”，它得是不可变的、且一次性的**，

很显然，LiveData 现有的设计是自相矛盾的 —— 一方面它通过权限分离设计来支持事件，甚至在官方文档推荐 SharedViewModel + LiveData 来跨域通信，可另一方面又缺乏对 “非粘性” 的支持，

所以我曾在[《Jetpack MVVM 精讲》](https://xiaozhuanlan.com/topic/0129483567)中公开质疑 “LiveData 不支持非粘性的设计” 是个 bug，很显然，这样的设计是令人迷惑的，在跨域通信的场景下，它不可避免地发生 “数据倒灌” 的问题，

万幸的是，经过一波三折，我们推出的[《UnPeek-LiveData》](https://github.com/KunMinX/UnPeek-LiveData)在小伙伴们积极的测试、反馈、重构下得以不断演进为今日的模样，成为包括 腾讯音乐、BMW、TCL 等知名厂商的软件都在使用的框架。

![](https://images.xiaozhuanlan.com/photo/2021/0089f6eb3948b887de1164d0208eb222.gif)

## 关于 “唯一可信源” 的定义

其实就和 “数据倒灌” 一样，“唯一可信源” 是我为了方便记忆和沟通，而于 2019 自创并在网上传播的 关于 **“通过权限收紧 来确保消息分发可靠一致 的结构性设计”** 的高度概括。

有的小伙伴将其与国外文档的 “Single Source of Truth（SSOT）” 混为一谈，实际上二者属于包含的关系，

也即 “唯一可信源”（The Only Source of Truth，TOSOT）比较广义，专注于解决 “发消息” 场景下的 “可靠性” 和 “一致性” 问题，

而 “Single Source of Truth” 比较狭义，也即 “无论发生什么事，你先去数据源请求一把，然后回推最新数据”，

这和我所谓的 “唯一可信源” 还是有一定的差别的，毕竟 “唯一可信源” 专注的是负责决策和消息分发本身，可以去数据层获取数据，也可以不去。区别就在这里。

![](https://images.xiaozhuanlan.com/photo/2021/45ee1bd153c8c6618db15c30613f8986.png)

## 综上

绝对的自由 往往隐含着对潜在风险的全面忽视，

要分清楚私事和公事，公事只能公办，不然出了问题很难找到负责人，

公私分明、统一监管，才可确保消息的可靠和一致，

并且出事时也有唯一的乙方来问责，这个乙方我们称之为 “唯一可信源”，

工程化的角度来说，私事就是可变的 “状态”，公事就是只读的 “事件” —— 公之于众，人们可以存档、可以形成自己的想法，但无权以讹传讹。

> **快捷访问：**
> 
> **[基本功：是随时随地可受用的 深度思考原则](https://xiaozhuanlan.com/topic/9837051426)**
> 
> [GitHub : 重学安卓 配套项目](https://github.com/KunMinX/Relearn-Android)
> 
> [GitHub : Jetpack-MVVM-Best-Practice](https://github.com/KunMinX/Jetpack-MVVM-Best-Practice)

## 版权声明

> Copyright © 2019-present KunMinX

**本文为专栏私有内容，谢绝转载**。

读者订阅了专栏，即享有了专栏文章的阅读权。

文章 **原创的引言、切入点、思路、结论** 凝聚了作者 KunMinX 本人的心血 及与参与者互动演化的结果，作者本人及作者在文中提名的有效贡献者 对相应的成果享有所有权。

**当您 借鉴或引用文中的引言、切入点、思路、结论 进行二次创作并打算发行时，须注明链接出处**，否则我们保留追责的权利。对此如有疑虑请及时沟通，或在发行前将作品交由本人核对。

当您看见有人 [洗稿](https://baike.baidu.com/item/%E6%B4%97%E7%A8%BF/20862574?fr=aladdin)、[剽窃](https://baike.baidu.com/item/%E5%89%BD%E7%AA%83/9398357?fr=aladdin)、未经授权转载本专栏的文章内容时，请及时向本人举报。

最后感谢您对专栏内容的阅读和喜欢。